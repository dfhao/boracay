<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hex.bigdata.udsp.ed.dao.ServiceCountMapper" >
    <resultMap id="BaseResultMap" type="com.hex.bigdata.udsp.ed.model.ServiceCount" >
        <id column="PK_ID" property="pkId" jdbcType="VARCHAR" />
        <result column="SERVICE_INFO_ID" property="serviceInfoId" jdbcType="VARCHAR" />
        <result column="SERVICE_NAME" property="serviceName" jdbcType="VARCHAR" />
        <result column="SERVICE_CN_NAME" property="serviceCnName" jdbcType="VARCHAR" />
        <result column="SERVICE_TYPE" property="serviceType" jdbcType="VARCHAR" />
        <result column="SERVICE_COMPANY" property="serviceCompany" jdbcType="VARCHAR" />
        <result column="REQUEST_USER" property="requestUser" jdbcType="VARCHAR" />
        <result column="REQUEST_TIME" property="requestTime" jdbcType="TIMESTAMP" />
    </resultMap>
    
    <resultMap id="BaseResultMapExtends" type="com.hex.bigdata.udsp.ed.dto.ServiceCountDto" extends="BaseResultMap">
        <result column="REQ_URL" property="reqUrl" jdbcType="VARCHAR" />
        <result column="SERVICE_DESC" property="serviceDesc" jdbcType="VARCHAR" />
        <result column="VALID_TIME" property="validTime" jdbcType="VARCHAR" />
    </resultMap>

    <insert id="addServiceCount" parameterType="com.hex.bigdata.udsp.ed.model.ServiceCount">
        INSERT INTO EDAP_SERVICE_COUNT
        (PK_ID, SERVICE_INFO_ID, SERVICE_NAME, SERVICE_CN_NAME, SERVICE_TYPE, SERVICE_COMPANY, REQUEST_USER, REQUEST_TIME)
        VALUES
        (#{pkId,jdbcType="VARCHAR"},#{serviceInfoId,jdbcType="VARCHAR"},#{serviceName,jdbcType="VARCHAR"},
        #{serviceCnName,jdbcType="VARCHAR"},#{serviceType,jdbcType="VARCHAR"},#{serviceCompany,jdbcType="VARCHAR"},
        #{requestUser,jdbcType="VARCHAR"},#{requestTime,jdbcType="TIMESTAMP"})
    </insert>
    <select id="getServiceCountList" resultMap="BaseResultMap" parameterType="com.hex.bigdata.udsp.ed.dto.ServiceCountDto">
        SELECT c.PK_ID, c.SERVICE_INFO_ID, c.SERVICE_NAME, c.SERVICE_CN_NAME, c.SERVICE_TYPE, c.SERVICE_COMPANY,
         c.REQUEST_USER, c.REQUEST_TIME
        FROM EDAP_SERVICE_COUNT c
        WHERE 1=1
        <if test="pkId != null and pkId != ''">and PK_ID = #{pkId}</if>
        <if test="serviceInfoId != null and serviceInfoId != ''">and SERVICE_INFO_ID = #{serviceInfoId}</if>
        <if test="serviceName != null and serviceName != ''">and SERVICE_NAME like '${serviceName}%'</if>
        <if test="serviceCnName != null and serviceCnName != ''">and SERVICE_CN_NAME like '%${serviceCnName}%'</if>
        <if test="serviceType != null and serviceType != ''">and SERVICE_TYPE = #{serviceType}</if>
        <if test="serviceCompany != null and serviceCompany != ''">and SERVICE_COMPANY = #{serviceCompany}</if>
        <if test="requestUser != null and requestUser != ''">and REQUEST_USER = #{requestUser}</if>
        <if test="startTime != null and startTime != ''">and c.REQUEST_TIME &gt;= to_date(#{startTime},'yyyy-mm-dd')</if>
        <if test="endTime != null and endTime != ''">and c.REQUEST_TIME &lt;= to_date(#{endTime},'yyyy-mm-dd')</if>
    </select>

    <select id="getServiceCountGroupByDay" resultMap="BaseResultMapExtends">
      SELECT i.PK_ID, i.SERVICE_NAME, i.SERVICE_CN_NAME, i.SERVICE_TYPE, i.SERVICE_COMPANY,i.VALID_TIME,
      i.REQ_URL, i.SERVICE_DESC, gb.intervalTime, gb.count
      FROM
      (SELECT count(c.REQUEST_TIME) as 'count', c.SERVICE_NAME, to_char(c.REQUEST_TIME,'yyyy-mm-dd') as intervalTime
        FROM EDAP_SERVICE_COUNT c GROUP BY c.SERVICE_NAME,to_char(c.REQUEST_TIME,'yyyy-mm-dd')) gb
      LEFT JOIN EDSP_SERVICE_INFO i on gb.SERVICE_NAME = i.SERVICE_NAME
      WHERE i.IS_DEL = '0'
      ORDER BY gb.intervalTime desc
    </select>
    
</mapper>